<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
	<link rel="manifest" href="manifest.json" />
	<link rel="icon" href="icon.svg" type="image/svg+xml" />
	<meta name="theme-color" content="#f6efe4" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="default" />

	<title>PlushClickerMobile</title>
	<style>
		@import url("https://fonts.googleapis.com/css2?family=Lexend:wght@400;600;700&display=swap");

		:root{
			--bg: #f6efe4;
			--bg-dark: #e7dac6;
			--ink: #1d1b19;
			--soil: #d4b08a;
			--soil-dark: #b7926c;
			--growing: #7fb2d9;
			--ready: #f3dc8a;
			--accent: #f08e6c;
			--accent-dark: #dd6f49;
			--card: #fff8ed;
			--shadow: rgba(30, 20, 10, 0.18);
			--cotton: #cfe7ff;
			--flax: #fff1b8;
			--memoria: #f6d7ff;
		}

		*{
			box-sizing: border-box;
		}

		html, body{
			margin: 0;
			height: 100%;
			background: var(--bg);
			color: var(--ink);
			font-family: "Lexend", "Trebuchet MS", sans-serif;
		}

		body{
			display: flex;
			justify-content: center;
		}

		.app{
			width: 100%;
			max-width: 686px;
			min-height: 100dvh;
			padding: clamp(10px, 2.6vw, 16px) clamp(10px, 3vw, 18px) clamp(14px, 3.2vw, 20px);
			background:
				radial-gradient(120px 120px at 20% 10%, rgba(255,255,255,0.65), transparent 70%),
				radial-gradient(160px 160px at 90% 0%, rgba(255,226,189,0.7), transparent 72%),
				linear-gradient(180deg, var(--bg) 0%, var(--bg-dark) 100%);
			position: relative;
			overflow: hidden;
		}

		.app::before,
		.app::after{
			content: "";
			position: absolute;
			inset: auto;
			opacity: 0.25;
			pointer-events: none;
		}

		.app::before{
			width: 200px;
			height: 200px;
			border-radius: 50%;
			background: #ffd7bf;
			top: -60px;
			left: -70px;
		}

		.app::after{
			width: 220px;
			height: 220px;
			border-radius: 50%;
			background: #f7eac7;
			bottom: -90px;
			right: -80px;
		}

		.header{
			position: relative;
			z-index: 1;
			display: flex;
			align-items: center;
			justify-content: space-between;
			margin-bottom: clamp(8px, 2.4vw, 12px);
		}

		.header-left{
			display: flex;
			align-items: center;
			gap: 10px;
		}

		.header-icon{
			width: clamp(34px, 7vw, 42px);
			height: clamp(34px, 7vw, 42px);
			border-radius: 12px;
			background: #fff;
			border: 2px solid rgba(0,0,0,0.08);
			padding: 4px;
		}

		.craft-actions{
			display: flex;
			align-items: center;
			gap: 8px;
		}

		.save-btn{
			border: 2px solid var(--ink);
			border-radius: 999px;
			padding: 4px 12px;
			background: #fff;
			font-size: clamp(9px, 2vw, 10px);
			text-transform: uppercase;
			letter-spacing: 0.8px;
			cursor: pointer;
		}

		.modal{
			position: fixed;
			inset: 0;
			background: rgba(0,0,0,0.45);
			display: none;
			align-items: center;
			justify-content: center;
			padding: 18px;
			z-index: 20;
		}

		.modal.open{
			display: flex;
		}

		.modal-panel{
			width: min(520px, 100%);
			background: var(--card);
			border-radius: 16px;
			padding: 14px;
			box-shadow: 0 14px 30px var(--shadow);
			border: 1px solid rgba(0,0,0,0.08);
		}

		.modal-header{
			display: flex;
			align-items: center;
			justify-content: space-between;
			margin-bottom: 10px;
		}

		.modal-title{
			font-weight: 700;
			font-size: clamp(13px, 2.6vw, 14px);
		}

		.modal-close{
			border: 0;
			background: transparent;
			font-size: 18px;
			cursor: pointer;
		}

		.modal-actions{
			display: flex;
			flex-wrap: wrap;
			gap: 8px;
			margin: 8px 0;
		}

		.modal-actions button{
			border: 2px solid var(--ink);
			border-radius: 10px;
			padding: 6px 10px;
			background: #fff;
			font-weight: 600;
			cursor: pointer;
		}

		.modal-actions input[type="file"]{
			display: none;
		}

		.modal-text{
			width: 100%;
			min-height: 140px;
			border: 2px solid var(--ink);
			border-radius: 12px;
			padding: 10px;
			font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
			font-size: 12px;
			resize: vertical;
		}

		.title{
			font-size: clamp(18px, 3.4vw, 20px);
			letter-spacing: 0.5px;
			font-weight: 700;
		}

		.subtitle{
			font-size: clamp(10px, 2.2vw, 11px);
			text-transform: uppercase;
			letter-spacing: 1px;
			opacity: 0.7;
		}

		.panel{
			position: relative;
			z-index: 1;
			background: var(--card);
			border-radius: 18px;
			padding: clamp(10px, 2.6vw, 12px);
			box-shadow: 0 10px 24px var(--shadow);
			border: 1px solid rgba(0,0,0,0.08);
		}

		.stats{
			display: grid;
			grid-template-columns: repeat(3, 1fr);
			gap: clamp(6px, 1.8vw, 8px);
			margin-bottom: clamp(8px, 2.4vw, 12px);
		}

		.stat{
			background: #fff;
			border-radius: 14px;
			padding: clamp(6px, 1.8vw, 8px);
			text-align: center;
			border: 1px solid rgba(0,0,0,0.08);
		}

		.stat h3{
			margin: 0;
			font-size: clamp(11px, 2.2vw, 12px);
			font-weight: 700;
		}

		.stat p{
			margin: 4px 0 0;
			font-size: clamp(9px, 2vw, 10px);
			text-transform: uppercase;
			letter-spacing: 0.8px;
			opacity: 0.7;
		}

		.stat.cotton{
			background: var(--cotton);
		}

		.stat.flax{
			background: var(--flax);
		}

		.stat.memoria{
			background: var(--memoria);
		}

		.selector{
			margin-bottom: clamp(8px, 2.4vw, 12px);
		}

		.selector h2{
			margin: 0 0 8px;
			font-size: clamp(11px, 2.2vw, 12px);
			text-transform: uppercase;
			letter-spacing: 1px;
			opacity: 0.7;
		}

		.plant-grid{
			display: grid;
			grid-template-columns: repeat(3, 1fr);
			gap: clamp(6px, 2vw, 8px);
		}

		.plant-btn{
			border: 2px solid var(--ink);
			background: #fff;
			border-radius: 14px;
			padding: clamp(6px, 2.2vw, 8px);
			text-align: center;
			cursor: pointer;
			font-weight: 700;
			transition: transform 0.15s ease, background 0.2s ease;
		}

		.plant-btn span{
			display: block;
			font-weight: 500;
			font-size: clamp(10px, 2vw, 11px);
			opacity: 0.7;
			margin-top: 4px;
		}

		.plant-btn.active{
			background: var(--accent);
			color: #1a110c;
			transform: translateY(-2px);
		}

		.craft{
			margin-bottom: clamp(8px, 2.4vw, 12px);
		}

		.craft-header{
			display: flex;
			justify-content: space-between;
			align-items: flex-start;
			gap: 12px;
		}

		.craft-title{
			font-size: clamp(13px, 2.6vw, 14px);
			font-weight: 700;
		}

		.craft-sub{
			font-size: clamp(10px, 2.2vw, 11px);
			opacity: 0.7;
			margin-top: 4px;
		}

		.kanade-total{
			font-size: clamp(18px, 3.4vw, 20px);
			letter-spacing: 0.3px;
			font-weight: 700;
		}

		.craft-controls{
			display: flex;
			align-items: center;
			justify-content: space-between;
			gap: clamp(8px, 2.4vw, 12px);
			flex-wrap: wrap;
			margin-top: clamp(6px, 2vw, 8px);
		}

		.craft-btn{
			flex: 1;
			min-width: 140px;
			padding: clamp(8px, 2.2vw, 10px) clamp(10px, 2.6vw, 12px);
			border: 2px solid var(--ink);
			border-radius: 14px;
			background: linear-gradient(90deg, #bb6588 var(--progress, 0%), #fff var(--progress, 0%));
			font-weight: 700;
			cursor: pointer;
			transition: transform 0.15s ease, background 0.2s ease;
		}

		.craft-btn:active{
			transform: translateY(1px);
		}

		.craft-btn:disabled{
			opacity: 0.6;
			cursor: not-allowed;
		}

		.craft-queue{
			font-size: clamp(10px, 2.2vw, 11px);
			text-transform: uppercase;
			letter-spacing: 0.8px;
			opacity: 0.7;
		}

		.craft-status{
			font-size: 10px;
			opacity: 0.8;
			margin-top: clamp(4px, 1.8vw, 6px);
		}


		.farm{
			display: grid;
			grid-template-columns: repeat(3, 1fr);
			gap: clamp(8px, 2.4vw, 10px);
		}

		.plot{
			border: 2px solid var(--ink);
			border-radius: 16px;
			background: linear-gradient(145deg, var(--soil), var(--soil-dark));
			aspect-ratio: 1 / 1;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			text-align: center;
			font-weight: 700;
			font-size: clamp(11px, 2.4vw, 12px);
			gap: clamp(2px, 1.4vw, 4px);
			cursor: pointer;
			box-shadow: inset 0 0 0 2px rgba(255,255,255,0.2);
			transition: transform 0.2s ease, background 0.3s ease;
		}

		.plot [hidden]{
			display: none;
		}

		.plot:active{
			transform: scale(0.98);
		}

		.plot-label{
			font-size: clamp(12px, 2.8vw, 14px);
		}

		.plot-time{
			font-size: clamp(11px, 2.4vw, 12px);
			font-weight: 600;
			opacity: 0.85;
		}

		.plot-badge{
			border: 2px solid var(--ink);
			border-radius: 999px;
			padding: clamp(2px, 1.6vw, 3px) clamp(8px, 3vw, 12px);
			font-size: clamp(11px, 2.6vw, 13px);
			font-weight: 700;
			background: #fff;
		}

		.plot-badge.cotton{
			background: var(--cotton);
		}

		.plot-badge.flax{
			background: var(--flax);
		}

		.plot-badge.memoria{
			background: linear-gradient(90deg, #ff9ecb 0%, #ffd59a 25%, #fff2a8 50%, #bfe6ff 75%, #d9b8ff 100%);
			font-size: 12px;
		}

		.plot.growing{
			background: linear-gradient(145deg, var(--growing), #5f92bc);
		}

		.plot.ready{
			background: linear-gradient(145deg, var(--ready), #e5c05c);
			animation: pulse 1.5s ease-in-out infinite;
		}

		@keyframes pulse{
			0%, 100%{ transform: scale(1); }
			50%{ transform: scale(1.03); }
		}

		.footer{
			margin-top: clamp(8px, 2.4vw, 10px);
			font-size: clamp(10px, 2.2vw, 11px);
			text-align: center;
			opacity: 0.75;
		}

		@media (min-width: 900px){
			.app{
				max-width: 420px;
				padding: 12px 12px 16px;
			}
		}

		@media (max-width: 360px){
			.app{
				padding: 14px 12px 18px;
			}

			.title{
				font-size: 18px;
			}

			.plot{
				border-radius: 12px;
				font-size: 11px;
			}

			.plot-label{
				font-size: 13px;
			}

			.plot-badge{
				font-size: 12px;
				padding: 2px 10px;
			}
		}
	</style>
</head>
<body>
	<main class="app">
		<header class="header">
			<div class="header-left">
				<img class="header-icon" src="icons/icon.svg" alt="Kanade plushie icon" />
				<div class="kanade-total"><span id="kanadeCount">0</span> Kanade Plushies</div>
			</div>
		</header>

		<section class="panel craft">
			<div class="craft-header">
				<div>
					<div class="craft-title">Plushie Maker</div>
					<div class="craft-sub">Recipe: 5 Cotton | 3 Flax | 1 Memoria</div>
				</div>
				<div class="craft-actions">
					<button class="save-btn" id="saveBtn" type="button">Import/Export</button>
				</div>
			</div>
			<div class="craft-controls">
				<button class="craft-btn" id="kanadeBtn" type="button">Start (1m)</button>
				<div class="craft-queue">Queue: <span id="kanadeQueue">0</span>/3</div>
			</div>
			<div class="craft-status" id="kanadeStatus">Idle</div>
		</section>

		<section class="stats">
			<div class="stat cotton">
				<h3 id="cottonCount">0</h3>
				<p>Cotton</p>
			</div>
			<div class="stat flax">
				<h3 id="flaxCount">0</h3>
				<p>Flax</p>
			</div>
			<div class="stat memoria">
				<h3 id="memoriaCount">0</h3>
				<p>Memoria</p>
			</div>
		</section>

		<section class="panel selector">
			<h2>Select plant</h2>
			<div class="plant-grid">
				<button class="plant-btn" data-plant="Cotton">
					Cotton
					<span data-plant-time>Cotton</span>
				</button>
				<button class="plant-btn" data-plant="Flax">
					Flax
					<span data-plant-time>Flax</span>
				</button>
				<button class="plant-btn" data-plant="Memoria">
					Memoria
					<span data-plant-time>Memoria</span>
				</button>
			</div>
		</section>

		<section class="panel farm" id="farm" aria-label="Farm plots"></section>

		<div class="footer">Tap an empty plot to plant. Tap ready plots to harvest.</div>
	</main>

	<div class="modal" id="saveModal" aria-hidden="true">
		<div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="saveTitle">
			<div class="modal-header">
				<div class="modal-title" id="saveTitle">Save Data</div>
				<button class="modal-close" id="saveClose" type="button" aria-label="Close">Ã—</button>
			</div>
			<div class="modal-actions">
				<button id="exportBtn" type="button">Download JSON</button>
				<button id="importBtn" type="button">Import File</button>
				<button id="resetBtn" type="button">Reset</button>
				<input type="file" id="importFile" accept=".json,application/json" />
			</div>
		</div>
	</div>

	<script>
		const STORAGE_KEY = "plush-farm-state-v1";

		const BASE_PLANTS = {
			Cotton: 30,
			Flax: 120,
			Memoria: 300
		};

		const KANADE_RECIPE = {
			Cotton: 5,
			Flax: 3,
			Memoria: 1
		};

		const BASE_KANADE_TIME = 60;

		const harvestCounts = {
			Cotton: 0,
			Flax: 0,
			Memoria: 0
		};

		const countEls = {
			Cotton: document.getElementById("cottonCount"),
			Flax: document.getElementById("flaxCount"),
			Memoria: document.getElementById("memoriaCount")
		};

		let selectedPlant = null;
		const farm = document.getElementById("farm");

		const kanadeBtn = document.getElementById("kanadeBtn");
		const kanadeQueueEl = document.getElementById("kanadeQueue");
		const kanadeCountEl = document.getElementById("kanadeCount");
		const kanadeStatusEl = document.getElementById("kanadeStatus");
		const saveBtn = document.getElementById("saveBtn");
		const saveModal = document.getElementById("saveModal");
		const saveClose = document.getElementById("saveClose");
		const exportBtn = document.getElementById("exportBtn");
		const importBtn = document.getElementById("importBtn");
		const resetBtn = document.getElementById("resetBtn");
		const importFile = document.getElementById("importFile");
		let kanadeTotal = 0;
		let kanadeQueue = 0;
		let kanadeInProgress = false;
		let kanadeReady = false;
		let kanadeTimeLeft = 0;
		let kanadeDuration = 0;
		let kanadeEndTime = 0;
		let kanadeTimer = null;

		const plots = [];
		const plotTimers = new Map();
		for (let i = 0; i < 9; i++) {
			const plot = document.createElement("button");
			plot.type = "button";
			plot.className = "plot";
			plot.dataset.state = "empty";
			plot.innerHTML = "<div class=\"plot-badge\" hidden></div><div class=\"plot-label\">Empty</div><div class=\"plot-time\" hidden>Tap to plant</div>";
			farm.appendChild(plot);
			plots.push(plot);
		}

		document.querySelectorAll(".plant-btn").forEach(btn => {
			btn.addEventListener("click", () => {
				document.querySelectorAll(".plant-btn").forEach(b => b.classList.remove("active"));
				btn.classList.add("active");
				selectedPlant = btn.dataset.plant;
			});
		});

		saveBtn.addEventListener("click", () => {
			saveModal.classList.add("open");
			saveModal.setAttribute("aria-hidden", "false");
		});

		saveClose.addEventListener("click", closeSaveModal);
		saveModal.addEventListener("click", event => {
			if (event.target === saveModal) closeSaveModal();
		});

		exportBtn.addEventListener("click", () => {
			const blob = new Blob([JSON.stringify(buildSaveState(), null, 2)], { type: "application/json" });
			const url = URL.createObjectURL(blob);
			const link = document.createElement("a");
			link.href = url;
			link.download = "plush-save.json";
			document.body.appendChild(link);
			link.click();
			link.remove();
			URL.revokeObjectURL(url);
		});

		importBtn.addEventListener("click", () => {
			importFile.click();
		});

		importFile.addEventListener("change", () => {
			const file = importFile.files[0];
			if (!file) return;
			file.text().then(text => {
				try {
					const parsed = JSON.parse(text);
					applySaveState(parsed);
					saveState();
					closeSaveModal();
					importFile.value = "";
				} catch (err) {
					alert("Invalid JSON data.");
				}
			});
		});

		resetBtn.addEventListener("click", () => {
			if (!confirm("Reset all save data?")) return;
			resetState();
			saveState();
			closeSaveModal();
		});

		plots.forEach(plot => {
			plot.addEventListener("click", () => {
				if (plot.dataset.state === "empty") {
					if (!selectedPlant) return;
					startPlant(plot, selectedPlant);
					return;
				}

				if (plot.dataset.state === "ready") {
					harvest(plot);
				}
			});
		});

		kanadeBtn.addEventListener("click", () => {
			if (kanadeReady) {
				collectKanade();
				return;
			}

			const totalQueued = kanadeQueue + (kanadeInProgress ? 1 : 0);
			if (totalQueued >= 3) return;
			if (!hasKanadeMaterials()) return;

			spendKanadeMaterials();
			if (kanadeInProgress) {
				kanadeQueue += 1;
				updateKanadeUI();
				saveState();
				return;
			}

			startKanadeCraft();
		});

		function getPlantTime(plant) {
			return BASE_PLANTS[plant];
		}

		function getKanadeTime() {
			return BASE_KANADE_TIME;
		}

		function updateTimeLabels() {
			document.querySelectorAll("[data-plant-time]").forEach(el => {
				const plant = el.closest(".plant-btn").dataset.plant;
				el.textContent = formatTime(getPlantTime(plant));
			});
		}

		function startPlant(plot, plant) {
			const duration = getPlantTime(plant);
			const endTime = Date.now() + (duration * 1000);
			setPlotGrowing(plot, plant, endTime);
			saveState();
		}

		function harvest(plot) {
			const plant = plot.dataset.plant;
			if (plant && harvestCounts[plant] !== undefined) {
				harvestCounts[plant] += 1;
				updateHarvestDisplays();
			}

			plot.dataset.state = "empty";
			plot.classList.remove("ready");
			plot.dataset.plant = "";
			setEmptyPlot(plot);
			saveState();
		}

		function setEmptyPlot(plot) {
			stopPlotTimer(plot);
			const badge = plot.querySelector(".plot-badge");
			const label = plot.querySelector(".plot-label");
			const time = plot.querySelector(".plot-time");

			plot.dataset.state = "empty";
			badge.hidden = true;
			badge.textContent = "";
			badge.classList.remove("cotton", "flax", "memoria");
			label.hidden = false;
			label.textContent = "Empty";
			time.hidden = true;
			time.textContent = "Tap to plant";
			plot.dataset.endTime = "";
		}

		function setPlotGrowing(plot, plant, endTime) {
			stopPlotTimer(plot);
			plot.dataset.plant = plant;
			plot.dataset.state = "growing";
			plot.dataset.endTime = String(endTime);
			plot.classList.remove("ready");
			plot.classList.add("growing");
			tickPlot(plot);

			const timer = setInterval(() => {
				tickPlot(plot);
			}, 1000);

			plotTimers.set(plot, timer);
		}

		function setPlotReady(plot) {
			stopPlotTimer(plot);
			plot.dataset.state = "ready";
			plot.classList.remove("growing");
			plot.classList.add("ready");
			updatePlot(plot, plot.dataset.plant, "Ready");
			plot.dataset.endTime = "";
		}

		function tickPlot(plot) {
			const plant = plot.dataset.plant;
			const endTime = Number(plot.dataset.endTime || 0);
			const remaining = Math.ceil((endTime - Date.now()) / 1000);
			if (!plant || remaining <= 0) {
				setPlotReady(plot);
				saveState();
				return;
			}
			updatePlot(plot, plant, formatTime(remaining));
		}

		function stopPlotTimer(plot) {
			if (plotTimers.has(plot)) {
				clearInterval(plotTimers.get(plot));
				plotTimers.delete(plot);
			}
		}

		function updatePlot(plot, title, time) {
			const badge = plot.querySelector(".plot-badge");
			const label = plot.querySelector(".plot-label");
			const timeEl = plot.querySelector(".plot-time");
			const plantClass = title.toLowerCase();

			badge.hidden = false;
			badge.textContent = title;
			badge.classList.remove("cotton", "flax", "memoria");
			badge.classList.add(plantClass);
			label.hidden = true;
			timeEl.hidden = false;
			timeEl.textContent = time;
		}

		function updateHarvestDisplays() {
			Object.keys(countEls).forEach(key => {
				countEls[key].textContent = harvestCounts[key];
			});
			updateKanadeUI();
		}

		function hasKanadeMaterials() {
			return (
				harvestCounts.Cotton >= KANADE_RECIPE.Cotton &&
				harvestCounts.Flax >= KANADE_RECIPE.Flax &&
				harvestCounts.Memoria >= KANADE_RECIPE.Memoria
			);
		}

		function spendKanadeMaterials() {
			harvestCounts.Cotton -= KANADE_RECIPE.Cotton;
			harvestCounts.Flax -= KANADE_RECIPE.Flax;
			harvestCounts.Memoria -= KANADE_RECIPE.Memoria;
			updateHarvestDisplays();
			saveState();
		}

		function startKanadeCraft() {
			kanadeInProgress = true;
			kanadeReady = false;
			kanadeTimeLeft = getKanadeTime();
			kanadeDuration = kanadeTimeLeft;
			kanadeEndTime = Date.now() + (kanadeDuration * 1000);
			updateKanadeUI();
			startKanadeTimer();
			saveState();
		}

		function startKanadeTimer() {
			if (kanadeTimer) {
				clearInterval(kanadeTimer);
			}

			kanadeTimer = setInterval(() => {
				kanadeTimeLeft = Math.max(0, Math.ceil((kanadeEndTime - Date.now()) / 1000));
				updateKanadeUI();
				if (kanadeTimeLeft <= 0) {
					clearInterval(kanadeTimer);
					kanadeInProgress = false;
					kanadeReady = true;
					kanadeTimeLeft = 0;
					updateKanadeUI();
					saveState();
				}
			}, 1000);
		}

		function collectKanade() {
			kanadeTotal += 1;
			kanadeCountEl.textContent = formatCount(kanadeTotal);
			kanadeReady = false;

			if (kanadeQueue > 0) {
				kanadeQueue -= 1;
				startKanadeCraft();
				return;
			}

			updateKanadeUI();
			saveState();
		}

		function updateKanadeUI() {
			const totalQueued = kanadeQueue + (kanadeInProgress ? 1 : 0);
			const canQueue = totalQueued < 3 && hasKanadeMaterials() && !kanadeReady;

			kanadeQueueEl.textContent = kanadeQueue;

			if (kanadeReady) {
				kanadeBtn.textContent = "Ready to collect";
				kanadeBtn.disabled = false;
				kanadeStatusEl.textContent = "Ready to collect";
				kanadeBtn.style.setProperty("--progress", "100%");
				return;
			}

			if (kanadeInProgress) {
				kanadeBtn.textContent = "In progress";
				kanadeBtn.disabled = !canQueue;
				kanadeStatusEl.textContent = "In progress: " + formatTime(kanadeTimeLeft);
				const progress = kanadeDuration > 0 ? (1 - (kanadeTimeLeft / kanadeDuration)) : 0;
				kanadeBtn.style.setProperty("--progress", (Math.max(0, Math.min(1, progress)) * 100) + "%");
				return;
			}

			kanadeBtn.textContent = "Start (" + formatTime(getKanadeTime()) + ")";
			kanadeBtn.disabled = !hasKanadeMaterials();
			kanadeStatusEl.textContent = "Idle";
			kanadeBtn.style.setProperty("--progress", "0%");
		}

		function buildSaveState() {
			const plotState = plots.map(plot => ({
				state: plot.dataset.state,
				plant: plot.dataset.plant || "",
				endTime: Number(plot.dataset.endTime || 0)
			}));

			return {
				harvestCounts,
				kanadeTotal,
				kanadeQueue,
				kanadeInProgress,
				kanadeReady,
				kanadeEndTime,
				kanadeDuration,
				plotState
			};
		}

		function saveState() {
			try {
				localStorage.setItem(STORAGE_KEY, JSON.stringify(buildSaveState()));
			} catch (err) {
				console.warn("Save failed:", err);
			}
		}

		function resetState() {
			harvestCounts.Cotton = 0;
			harvestCounts.Flax = 0;
			harvestCounts.Memoria = 0;
			kanadeTotal = 0;
			kanadeQueue = 0;
			kanadeInProgress = false;
			kanadeReady = false;
			kanadeTimeLeft = 0;
			kanadeDuration = 0;
			kanadeEndTime = 0;
			selectedPlant = null;
			document.querySelectorAll(".plant-btn").forEach(b => b.classList.remove("active"));
			plots.forEach(plot => {
				plot.dataset.plant = "";
				setEmptyPlot(plot);
			});
			updateHarvestDisplays();
			kanadeCountEl.textContent = formatCount(kanadeTotal);
			updateTimeLabels();
			updateKanadeUI();
		}

		function applySaveState(state) {
			if (!state || typeof state !== "object") return;
			if (state.harvestCounts) {
				harvestCounts.Cotton = state.harvestCounts.Cotton || 0;
				harvestCounts.Flax = state.harvestCounts.Flax || 0;
				harvestCounts.Memoria = state.harvestCounts.Memoria || 0;
			}

			kanadeTotal = state.kanadeTotal || 0;
			kanadeQueue = state.kanadeQueue || 0;
			kanadeInProgress = Boolean(state.kanadeInProgress);
			kanadeReady = Boolean(state.kanadeReady);
			kanadeEndTime = Number(state.kanadeEndTime || 0);
			kanadeDuration = Number(state.kanadeDuration || 0);

			const now = Date.now();
			if (kanadeInProgress && !kanadeEndTime) {
				kanadeEndTime = Date.now() + ((kanadeDuration || getKanadeTime()) * 1000);
			}

			if (kanadeInProgress && kanadeEndTime) {
				kanadeTimeLeft = Math.max(0, Math.ceil((kanadeEndTime - now) / 1000));
				if (kanadeTimeLeft <= 0) {
					kanadeInProgress = false;
					kanadeReady = true;
					kanadeTimeLeft = 0;
				} else {
					startKanadeTimer();
				}
			}

			if (Array.isArray(state.plotState)) {
				state.plotState.forEach((plotData, index) => {
					const plot = plots[index];
					if (!plot) return;
					if (plotData.state === "growing" && plotData.plant && plotData.endTime) {
						if (plotData.endTime <= now) {
							plot.dataset.plant = plotData.plant;
							setPlotReady(plot);
						} else {
							setPlotGrowing(plot, plotData.plant, plotData.endTime);
						}
					} else if (plotData.state === "ready" && plotData.plant) {
						plot.dataset.plant = plotData.plant;
						setPlotReady(plot);
					} else {
						setEmptyPlot(plot);
					}
				});
			}
		}

		function loadState() {
			try {
				const raw = localStorage.getItem(STORAGE_KEY);
				if (!raw) return;
				const state = JSON.parse(raw);
				applySaveState(state);
			} catch (err) {
				console.warn("Load failed:", err);
			}
		}

		function closeSaveModal() {
			saveModal.classList.remove("open");
			saveModal.setAttribute("aria-hidden", "true");
		}

		function formatCount(value) {
			return value.toLocaleString("en-US");
		}

		function formatTime(totalSeconds) {
			const minutes = Math.floor(totalSeconds / 60);
			const seconds = totalSeconds % 60;
			if (minutes <= 0) return seconds + "s";
			return minutes + "m " + String(seconds).padStart(2, "0") + "s";
		}

		loadState();
		kanadeCountEl.textContent = formatCount(kanadeTotal);
		updateHarvestDisplays();
		updateTimeLabels();
		updateKanadeUI();
		if ("serviceWorker" in navigator) {
			window.addEventListener("load", () => {
				navigator.serviceWorker.register("sw.js");
			});
		}

	</script>
</body>
</html>
